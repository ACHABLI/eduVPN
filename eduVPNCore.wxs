<?xml version="1.0" encoding="utf-8"?>
<!--
    eduVPN - End-user friendly VPN

    Copyright: 2017, The Commons Conservancy eduVPN Programme
    SPDX-License-Identifier: GPL-3.0+
-->
<Wix
    xmlns="http://schemas.microsoft.com/wix/2006/wi"
    xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">
    <Product
        Id="$(var.eduVPN.Client.ProductGUID)"
        UpgradeCode="{ADD9689E-1061-43AF-85C6-2AAB99A7284E}"
        Version="$(var.eduVPN.Client.Version)"
        Language="!(loc.ProductLanguage)"
        Name="!(loc.ApplicationCoreName) $(var.eduVPN.Client.VersionInformational)"
        Manufacturer="!(loc.ManufacturerName)">

        <Package
            InstallScope="perMachine"
            InstallerVersion="400"
            Compressed="yes"
            SummaryCodepage="!(loc.SummaryCodepage)"
            ReadOnly="yes"/>

        <Media
            Id="1"
            Cabinet="Core.cab"
            EmbedCab="yes"/>

        <Icon
            Id="eduVPN.ico"
            SourceFile="eduVPN.Client\Resources\eduVPN.ico"/>

        <Property Id="ARPPRODUCTICON" Value="eduVPN.ico"/>
        <Property Id="ARPURLINFOABOUT" Value="https://eduvpn.org/"/>


        <!--
            Upgrading functionality
        -->
        <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes"/>
        <Upgrade Id="{ADD9689E-1061-43AF-85C6-2AAB99A7284E}">
            <UpgradeVersion
                Minimum="1.0.0"
                Property="PREVIOUSVERSIONSINSTALLED"
                IncludeMinimum="yes"
                MigrateFeatures="yes"/>
        </Upgrade>
        <InstallExecuteSequence>
            <RemoveExistingProducts Before="InstallInitialize"/>
        </InstallExecuteSequence>
        <Property Id="BINDIRPREV">
            <ComponentSearch Id="eduEd25519.dll" Guid="{4D1F1278-9044-4AFD-98E1-71BB39FCB0F1}"/>
            <ComponentSearch Id="eduJSON.dll" Guid="{BC7AF3B7-872E-405C-A319-391CA0FB40D4}"/>
            <ComponentSearch Id="eduOAuth.dll" Guid="{8B85976D-4CFC-4543-B583-06C75E92A6FD}"/>
            <ComponentSearch Id="eduOpenVPN.dll" Guid="{809A5107-82D9-4271-BE32-37427C14BCA7}"/>
            <ComponentSearch Id="Prism.dll" Guid="{7F1F7FAC-3959-40D5-A379-AE70762D6335}"/>
            <ComponentSearch Id="eduVPN.dll" Guid="{363C4CCB-B18B-4BA8-AB89-797564B388C2}"/>
            <ComponentSearch Id="eduVPN.dll.config" Guid="{EDE7F8DE-521D-4034-8BB7-B6545CA7F49E}"/>
            <ComponentSearch Id="eduVPN.Client.exe" Guid="{ED87A5F5-CCED-46EA-8D4E-443CA747E4D8}"/>
            <ComponentSearch Id="eduVPN.Client.exe.config" Guid="{8382A373-0C73-4D16-8F33-CA9FF91C24D0}"/>
            <ComponentSearch Id="eduVPN.Resources.dll" Guid="{39778E20-4F27-40B2-90C3-FC16A28E70B5}"/>
            <ComponentSearch Id="OpenVPN.Resources.dll" Guid="{B1F28A18-CDC3-4D0D-B0E9-4BC79E876E4E}"/>
        </Property>
        <SetProperty
            After="AppSearch"
            Action="SetBinDirPrev"
            Id="BINDIR"
            Value="[BINDIRPREV]"
            Sequence="first"><![CDATA[BINDIRPREV AND NOT Installed]]></SetProperty>


        <!--
            .NET Framework check
        -->
        <PropertyRef Id="NETFRAMEWORK45"/>
        <Condition Message="!(loc.DotNETFrameworkMissing)"><![CDATA[Installed OR NETFRAMEWORK45]]></Condition>


        <!--
            Folders
        -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="$(var.eduVPN.ProgramFilesFolder)">
                <Directory Id="EDUVPNDIR" Name="eduVPN">
                    <Directory Id="BINDIR" Name="Core" FileSource="$(var.eduVPN.TargetDir)">
                        <Directory Id="RESDIRSL" Name="sl"/>
                    </Directory>
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder"/>
            <Directory Id="DesktopFolder"/>

            <Merge Id="VC150Redist" SourceFile="$(var.eduVPN.VC150RedistMSM)" DiskId="1" Language="0"/>
        </Directory>


        <!--
            Features
        -->
        <Feature Id="eduVPN.Client" Title="!(loc.ApplicationCoreName)" Level="1">
            <MergeRef Id="VC150Redist"/>

            <ComponentGroupRef Id="eduVPN.Client.exe"/>
        </Feature>


        <!--
            Prism
        -->
        <DirectoryRef Id="BINDIR">
            <Component Id="Prism.dll" Guid="{7F1F7FAC-3959-40D5-A379-AE70762D6335}">
                <File Source="Prism.dll"/>
            </Component>
        </DirectoryRef>
        <ComponentGroup Id="Prism">
            <ComponentRef Id="Prism.dll"/>
        </ComponentGroup>
    </Product>
</Wix>
